workflow:
  id: query-victoriametrics
  name: victoriametrics-alert-example
  description: victoriametrics
  triggers:
    - type: manual
  steps:
    - name: victoriametrics-step
      provider:
        config: "{{ providers.vm }}"
        type: victoriametrics
        with:
          query: avg(rate(process_cpu_seconds_total))
          queryType: query

  actions:
    - name: create-alert
      # only create an alert if the CPU usage is greater than 0.005
      if: "{{ steps.victoriametrics-step.results.data.result.0.value.1 }} > 0.001 "
      provider:
        type: keep
        # create an alert with the following details
        with:
          name: "High CPU Usage"
          description: "CPU usage is high on the VM (created from VM metric)"
          severity: '{{ steps.victoriametrics-step.results.data.result.0.value.1 }} > 0.9 ? "critical" : {{ steps.victoriametrics-step.results.data.result.0.value.1 }} > 0.7 ? "warning" : "info"'
          labels:
            environment: production
            app: myapp
            service: api
            team: devops
            owner: alice
          # optional: customize the fingerprint based on these fields
          fingerprint_fields:
            - environment
            - app
            - service
            - team
            - owner
